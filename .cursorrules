# Geskap Order Management & CinetPay Integration Rules

## Project Context
This is a React/TypeScript e-commerce management system built with Firebase, implementing a comprehensive order management system with CinetPay mobile money integration for the Cameroon market.

## Core Technologies
- **Frontend**: React 18, TypeScript, Vite, Tailwind CSS
- **Backend**: Firebase (Firestore, Auth, Storage)
- **Payment**: CinetPay Seamless SDK for mobile money integration
- **State Management**: React Context, Custom Hooks
- **UI**: Lucide React icons, React Hot Toast notifications

## Architecture Principles

### Order Management System
- **Order Persistence**: All orders must be stored in Firestore with complete traceability
- **Status Tracking**: Every order status change must be logged with timestamp and user
- **User Isolation**: Each company/user can only access their own orders
- **Audit Trail**: Complete timeline of all order events and changes

### CinetPay Integration
- **User-Specific Config**: Each company has separate CinetPay configuration
- **Seamless Integration**: Use CinetPay Seamless SDK for popup-based payments
- **Currency**: XAF (Cameroon Franc) as primary currency
- **Payment Methods**: Mobile Money (MTN, Orange), Bank Cards, Bank Transfers
- **Security**: Encrypt API keys, validate webhooks, verify transactions

### Data Models
```typescript
// Core order structure
interface Order extends BaseModel {
  orderId: string;
  orderNumber: string;
  customerInfo: CustomerInfo;
  items: OrderItem[];
  pricing: OrderPricing;
  orderType: 'whatsapp' | 'online';
  status: OrderStatus;
  paymentStatus: PaymentStatus;
  paymentMethod: PaymentMethodType;
  paymentDetails?: CinetPayDetails;
  deliveryInfo: DeliveryInfo;
  timeline: OrderEvent[];
  metadata: OrderMetadata;
}

// CinetPay configuration per user
interface CinetPayConfig extends BaseModel {
  siteId: string;
  apiKey: string; // encrypted
  currency: 'XAF';
  isActive: boolean;
  supportedMethods: string[];
  minAmount: number;
  maxAmount: number;
}
```

## Development Guidelines

### Code Organization
- **Services**: All business logic in `/src/services/`
- **Types**: All TypeScript interfaces in `/src/types/`
- **Components**: Reusable components in `/src/components/`
- **Pages**: Main application pages in `/src/pages/`
- **Hooks**: Custom hooks in `/src/hooks/`

### Firebase Integration
- **Security Rules**: Always implement proper Firestore security rules
- **Batch Operations**: Use Firestore batch writes for atomic operations
- **Real-time Updates**: Use Firestore listeners for real-time data
- **Error Handling**: Comprehensive error handling for all Firebase operations

### CinetPay Integration
- **SDK Loading**: Load CinetPay SDK in index.html
- **Configuration**: Store CinetPay config per user in Firestore
- **Payment Flow**: Initialize → Process → Verify → Update Order
- **Error Handling**: Handle all CinetPay error scenarios gracefully
- **iOS Safari**: Implement fallback for iOS Safari popup issues

### Order Management
- **Order Creation**: Convert cart to persistent order with complete data
- **Status Updates**: Always log status changes with full context
- **Payment Processing**: Integrate CinetPay with order status updates
- **Admin Interface**: Provide comprehensive order management dashboard

## Security Requirements

### Data Protection
- **Encryption**: Encrypt sensitive data (API keys, payment details)
- **Access Control**: Implement role-based access control
- **Input Validation**: Validate all user inputs and API data
- **Audit Logging**: Log all critical operations for compliance

### Payment Security
- **API Key Protection**: Never expose CinetPay API keys in frontend
- **Webhook Verification**: Verify CinetPay webhook authenticity
- **Transaction Validation**: Verify payment amounts and details
- **PCI Compliance**: Follow PCI DSS guidelines for payment processing

## Performance Considerations

### Database Optimization
- **Indexing**: Create proper Firestore indexes for queries
- **Pagination**: Implement pagination for large order lists
- **Caching**: Use appropriate caching strategies
- **Batch Operations**: Use batch writes for multiple operations

### Frontend Optimization
- **Lazy Loading**: Load order data on demand
- **Memoization**: Use React.memo and useMemo appropriately
- **Bundle Size**: Keep bundle size optimized
- **Mobile Performance**: Ensure smooth mobile experience

## Error Handling

### Order System Errors
- **Order Creation Failures**: Graceful handling with user feedback
- **Status Update Errors**: Retry logic and error reporting
- **Payment Failures**: Clear error messages and retry options
- **Data Validation**: Comprehensive validation with helpful messages

### CinetPay Errors
- **Payment Failures**: Handle all CinetPay error codes
- **Network Issues**: Implement retry logic and fallbacks
- **API Errors**: Proper error handling and user communication
- **Webhook Failures**: Handle webhook processing errors

## Testing Requirements

### Unit Testing
- **Service Functions**: Test all order and payment service functions
- **Component Logic**: Test component business logic
- **Data Validation**: Test all data validation functions
- **Error Scenarios**: Test all error handling paths

### Integration Testing
- **Order Flow**: Test complete order creation and processing
- **Payment Flow**: Test CinetPay integration end-to-end
- **Admin Interface**: Test all admin order management features
- **Mobile Testing**: Test on various mobile devices and browsers

## Deployment Considerations

### Environment Configuration
- **Development**: Use CinetPay sandbox environment
- **Staging**: Test with real CinetPay test environment
- **Production**: Use CinetPay production environment
- **Environment Variables**: Secure configuration management

### Monitoring
- **Order Metrics**: Track order processing and success rates
- **Payment Metrics**: Monitor payment success and failure rates
- **Performance Metrics**: Monitor system performance and response times
- **Error Tracking**: Comprehensive error logging and monitoring

## Code Quality Standards

### TypeScript
- **Strict Mode**: Use strict TypeScript configuration
- **Type Safety**: Ensure all data is properly typed
- **Interface Definitions**: Define clear interfaces for all data structures
- **Error Types**: Define specific error types for better error handling

### React Best Practices
- **Functional Components**: Use functional components with hooks
- **Custom Hooks**: Extract reusable logic into custom hooks
- **Context Usage**: Use React Context appropriately for global state
- **Performance**: Optimize re-renders and component updates

### Code Organization
- **File Naming**: Use consistent file naming conventions
- **Folder Structure**: Maintain clear folder structure
- **Import Organization**: Organize imports logically
- **Comment Standards**: Add meaningful comments for complex logic

## Documentation Requirements

### Code Documentation
- **Function Comments**: Document all public functions
- **Interface Documentation**: Document all TypeScript interfaces
- **API Documentation**: Document all service APIs
- **Integration Guides**: Document CinetPay integration process

### User Documentation
- **Admin Guide**: Document admin order management features
- **Customer Guide**: Document customer ordering process
- **Troubleshooting**: Document common issues and solutions
- **Configuration**: Document CinetPay configuration process

## Future Considerations

### Scalability
- **Microservices**: Consider microservices architecture for future scaling
- **Caching**: Implement advanced caching strategies
- **CDN**: Use CDN for global performance
- **Database Optimization**: Advanced database optimization techniques

### Feature Enhancements
- **AI Analytics**: Machine learning for order predictions
- **Advanced Reporting**: More sophisticated reporting capabilities
- **Mobile App**: Native mobile application development
- **Multi-language**: Expand language support beyond French/English

## Compliance Requirements

### Data Protection
- **GDPR Compliance**: Follow GDPR guidelines for data protection
- **Data Retention**: Implement proper data retention policies
- **User Consent**: Obtain proper consent for data processing
- **Data Portability**: Allow users to export their data

### Payment Compliance
- **PCI DSS**: Follow PCI DSS guidelines for payment processing
- **Financial Regulations**: Comply with local financial regulations
- **Audit Requirements**: Maintain audit trails for compliance
- **Security Standards**: Follow industry security standards

---

## Quick Reference

### Key Files
- **Order Service**: `/src/services/orderService.ts`
- **CinetPay Service**: `/src/services/cinetpayService.ts`
- **Order Types**: `/src/types/order.ts`
- **Order Page**: `/src/pages/Orders.tsx`
- **Checkout**: `/src/pages/Checkout.tsx`

### Important Commands
- **Development**: `npm run dev`
- **Build**: `npm run build`
- **Lint**: `npm run lint`
- **Firebase Deploy**: `npm run deploy:rules`

### CinetPay Integration
- **SDK**: Load from `https://cdn.cinetpay.com/seamless/main.js`
- **Configuration**: Store in `cinetpay_configs` collection
- **Webhook**: Handle at `/api/cinetpay/webhook`
- **Currency**: Use `XAF` for Cameroon market

Remember: Always prioritize security, user experience, and data integrity in all implementations.
