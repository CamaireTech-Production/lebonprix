rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isManager() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'manager';
    }
    
    // Helper function to check if user owns a company
    // SIMPLIFIED: Only checks ownership, no employee checks
    // Client-side filtering handles company access for employees
    function isOwnerOfCompany(companyId) {
      return isAuthenticated() && (
        // Legacy: check if companyId is userId (grandfathered companies)
        companyId == request.auth.uid ||
        // New: check userId field in company
        get(/databases/$(database)/documents/companies/$(companyId)).data.userId == request.auth.uid
      );
    }
    
    function isUserInSameCompany(userId) {
      let user = get(/databases/$(database)/documents/users/$(userId)).data;
      let currentUser = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      
      // Simplified check - if both users exist, they might share a company
      return user != null && currentUser != null;
    }
    
    // User profiles - Nouveau système unifié
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || 
        isUserInSameCompany(userId)
      );
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false; // Pas de suppression complète
    }
    
    // Products - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /products/{productId} {
      // Allow list/get for authenticated users - client filters by companyId
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      // Only owners can write
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      
      // Validate product data
      function isValidProduct() {
        let data = request.resource.data;
        return data.name is string && data.name.size() > 0 &&
               data.costPrice is number && data.costPrice >= 0 &&
               data.sellingPrice is number && data.sellingPrice >= data.costPrice &&
               data.stock is number && data.stock >= 0 &&
               (!('category' in data) || data.category is string) &&
               data.companyId is string &&
               (!('imageUrl' in data) || data.imageUrl is string) &&
               data.isAvailable is bool;
      }
      
      allow create: if isValidProduct() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isValidProduct() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Sales - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /sales/{saleId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      
      // Validate sale data
      function isValidSale() {
        let data = request.resource.data;
        return data.products is list && data.products.size() > 0 &&
               data.totalAmount is number && data.totalAmount >= 0 &&
               data.companyId is string &&
               data.userId is string &&
               data.createdAt is timestamp;
      }
      
      allow create: if isValidSale() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isValidSale() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Expenses - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /expenses/{expenseId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      
      // Validate expense data
      function isValidExpense() {
        let data = request.resource.data;
        return data.description is string && data.description.size() > 0 &&
               data.amount is number && data.amount > 0 &&
               data.companyId is string &&
               ((data.date is timestamp) || (data.createdAt is timestamp)) &&
               (!('attachments' in data) || (data.attachments is list && data.attachments.size() <= 5));
      }
      
      function createdAtNotModified() {
        return !('createdAt' in request.resource.data) || 
               request.resource.data.createdAt == resource.data.createdAt;
      }
      
      allow create: if isValidExpense() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isValidExpense() && isOwnerOfCompany(resource.data.companyId) && createdAtNotModified();
    }
    
    // Dashboard stats - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /dashboardStats/{statsId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow write: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
    }
    
    // Finances - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /finances/{financeId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if false; // Only soft deletion allowed
    }

    // Finance Entry Types - SIMPLIFIED: Public read, owners only for writes
    match /financeEntryTypes/{typeId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
        (!('isDefault' in request.resource.data) || request.resource.data.isDefault == false) && 
        isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && 
        (!('isDefault' in resource.data) || resource.data.isDefault == false) &&
        isOwnerOfCompany(resource.data.companyId);
      allow delete: if false;
    }
    
    // Expense Types - SIMPLIFIED: Public read, owners only for writes
    match /expenseTypes/{typeId} {
      allow read: if true;
      allow create: if isAuthenticated() && 
        (!('isDefault' in request.resource.data) || request.resource.data.isDefault == false) &&
        isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && 
        (!('isDefault' in resource.data) || resource.data.isDefault == false) &&
        isOwnerOfCompany(resource.data.companyId);
      allow delete: if false;
    }
    
    // Companies - Architecture simplifiée
    match /companies/{companyId} {
      allow read: if true; // Public read for landing pages
      allow create: if isAuthenticated(); // N'importe quel utilisateur connecté peut créer
      allow update: if isAuthenticated() && isOwnerOfCompany(companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(companyId);
      
      // Employee subcollection - SIMPLIFIED: Authenticated read, owners only for writes
      match /employees/{employeeId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && isOwnerOfCompany(companyId);
        allow update: if isAuthenticated() && isOwnerOfCompany(companyId);
        allow delete: if isAuthenticated() && isOwnerOfCompany(companyId);
        
        // Validate employee data
        function isValidEmployee() {
          let data = request.resource.data;
          return data.id is string && data.id.size() > 0 &&
                 data.firstname is string && data.firstname.size() > 0 &&
                 data.lastname is string && data.lastname.size() > 0 &&
                 data.email is string && data.email.matches('.*@.*\\..*') &&
                 data.role in ['admin', 'manager', 'staff'] &&
                 data.createdAt is timestamp &&
                 data.updatedAt is timestamp &&
                 (!('phone' in data) || data.phone is string) &&
                 (!('birthday' in data) || data.birthday is string) &&
                 (!('loginLink' in data) || data.loginLink is string) &&
                 (!('firebaseUid' in data) || data.firebaseUid is string);
        }
        
        allow create: if isValidEmployee();
        allow update: if isValidEmployee();
      }
      
      // Profit Period Preference subcollection - SIMPLIFIED
      match /profitPeriodPreference/{prefId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated() && 
          isOwnerOfCompany(companyId) &&
          request.resource.data.companyId == companyId &&
          request.resource.data.updatedBy == request.auth.uid;
      }
      
      // Employee Refs subcollection - SIMPLIFIED rules
      match /employeeRefs/{employeeRefId} {
        // Allow list for company owners (legacy or new)
        allow list: if isAuthenticated() && (
          companyId == request.auth.uid ||
          get(/databases/$(database)/documents/companies/$(companyId)).data.userId == request.auth.uid
        );
        // Allow get: user can read their own ref, or if they're owner
        allow get: if isAuthenticated() && (
          employeeRefId == request.auth.uid ||
          companyId == request.auth.uid ||
          get(/databases/$(database)/documents/companies/$(companyId)).data.userId == request.auth.uid
        );
        // Only owners can create/update/delete
        allow create: if isAuthenticated() && (
          companyId == request.auth.uid ||
          get(/databases/$(database)/documents/companies/$(companyId)).data.userId == request.auth.uid
        );
        allow update: if isAuthenticated() && (
          companyId == request.auth.uid ||
          get(/databases/$(database)/documents/companies/$(companyId)).data.userId == request.auth.uid
        );
        allow delete: if isAuthenticated() && (
          companyId == request.auth.uid ||
          get(/databases/$(database)/documents/companies/$(companyId)).data.userId == request.auth.uid
        );
      }
      
      // Permission Templates subcollection - SIMPLIFIED: Authenticated read, owners only for writes
      match /permissionTemplates/{templateId} {
        allow list: if isAuthenticated();
        allow get: if isAuthenticated();
        allow create: if isAuthenticated() && isOwnerOfCompany(companyId);
        allow update: if isAuthenticated() && isOwnerOfCompany(companyId);
        allow delete: if isAuthenticated() && isOwnerOfCompany(companyId);
      }
    }

    // Audit Logs
    match /auditLogs/{logId} {
      allow read: if isAuthenticated() && resource.data.performedBy == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.performedBy == request.auth.uid;
      allow update: if false; // Audit logs should not be updated
      allow delete: if false; // Audit logs should not be deleted
    }
    
    // Categories - SIMPLIFIED: Public read, owners only for writes
    match /categories/{categoryId} {
      allow read: if true;
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Suppliers - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /suppliers/{supplierId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Objectives - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /objectives/{objectiveId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Stock Batches - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /stockBatches/{batchId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if false; // Stock batches should not be deleted directly
    }
    
    // Stock Changes - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /stockChanges/{changeId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if false; // Stock changes are immutable
      allow delete: if false; // Stock changes should not be deleted
    }
    
    // Customers - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /customers/{customerId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if false; // Soft delete only
    }
    
    // Customer Sources - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /customerSources/{sourceId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Orders - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /orders/{orderId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if false; // Only soft deletion allowed
      
      // Validate order data
      function isValidOrder() {
        let data = request.resource.data;
        return data.orderId is string && data.orderId.size() > 0 &&
               data.orderNumber is string && data.orderNumber.size() > 0 &&
               data.companyId is string &&
               data.customerInfo.name is string && data.customerInfo.name.size() > 0 &&
               data.customerInfo.phone is string && data.customerInfo.phone.size() > 0 &&
               data.customerInfo.location is string && data.customerInfo.location.size() > 0 &&
               data.items is list && data.items.size() > 0 &&
               data.pricing.subtotal is number && data.pricing.subtotal >= 0 &&
               data.pricing.deliveryFee is number && data.pricing.deliveryFee >= 0 &&
               data.pricing.total is number && data.pricing.total >= 0 &&
               data.orderType in ['whatsapp', 'online'] &&
               data.status in ['pending', 'confirmed', 'preparing', 'ready', 'delivered', 'cancelled'] &&
               data.paymentStatus in ['pending', 'paid', 'failed', 'awaiting_payment', 'cancelled'] &&
               data.paymentMethod in ['onsite', 'online', 'whatsapp'] &&
               data.deliveryInfo.method in ['pickup', 'delivery'] &&
               data.timeline is list &&
               data.metadata.source in ['catalogue', 'admin', 'checkout', 'checkout_modal'];
      }
      
      allow create: if isValidOrder() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isValidOrder() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Order Events - SIMPLIFIED: Authenticated read, owners only for writes
    match /orders/{orderId}/events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        isOwnerOfCompany(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow update: if false; // Events should not be updated
      allow delete: if false; // Events should not be deleted
    }
    
    // Order Payments - SIMPLIFIED: Authenticated read, owners only for writes
    match /orders/{orderId}/payments/{paymentId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        isOwnerOfCompany(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow update: if isAuthenticated() && 
        isOwnerOfCompany(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow delete: if false; // Payments should not be deleted
    }
    
    // Order Notes - SIMPLIFIED: Authenticated read, owners only for writes
    match /orders/{orderId}/notes/{noteId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        isOwnerOfCompany(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow update: if isAuthenticated() && 
        isOwnerOfCompany(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow delete: if false; // Notes should not be deleted
    }
    
    // CinetPay Configurations - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /cinetpay_configs/{configId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if false; // Configurations should not be deleted
      
      // Validate CinetPay configuration data
      function isValidCinetPayConfig() {
        let data = request.resource.data;
        return data.companyId is string &&
               data.siteId is string &&
               data.apiKey is string &&
               data.isActive is bool &&
               data.testMode is bool &&
               data.enabledChannels.mobileMoney is bool &&
               data.enabledChannels.creditCard is bool &&
               data.enabledChannels.wallet is bool &&
               data.currency == 'XAF';
      }
      
      allow create: if isValidCinetPayConfig() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isValidCinetPayConfig() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // CinetPay Transactions - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /cinetpay_transactions/{transactionId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if false; // Transactions should not be deleted
    }
    
    // Production Flow Steps - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /productionFlowSteps/{stepId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Production Flows - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /productionFlows/{flowId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Production Categories - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /productionCategories/{categoryId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Productions - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    // Special update rule allows partial updates (e.g., adding fixed charges)
    match /productions/{productionId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      // Special update rule: allows partial updates without companyId in request
      // This preserves the ability to add fixed charges to existing productions
      allow update: if isAuthenticated() && 
        isOwnerOfCompany(resource.data.companyId) && 
        (!('companyId' in request.resource.data) || request.resource.data.companyId == resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Charges - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    // Special update rule allows partial updates
    match /charges/{chargeId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      // Allow partial updates (companyId may not be in update)
      allow update: if isAuthenticated() && 
        isOwnerOfCompany(resource.data.companyId) && 
        (!('companyId' in request.resource.data) || request.resource.data.companyId == resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      
      // Validate charge data
      function isValidCharge() {
        let data = request.resource.data;
        return data.companyId is string &&
               data.type in ['fixed', 'custom'] &&
               (data.name is string || data.description is string) &&
               data.amount is number && data.amount >= 0 &&
               (!('category' in data) || data.category is string) &&
               data.date is timestamp &&
               data.userId is string &&
               (!('isActive' in data) || data.isActive is bool);
      }
      
      allow create: if isValidCharge() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isValidCharge() && isOwnerOfCompany(resource.data.companyId);
    }
    
    // Production Charges - SIMPLIFIED: Client-side filtering for reads, owners only for writes
    match /productionCharges/{chargeId} {
      allow list: if isAuthenticated();
      allow get: if isAuthenticated();
      allow create: if isAuthenticated() && isOwnerOfCompany(request.resource.data.companyId);
      allow update: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(resource.data.companyId);
    }
  }
}
