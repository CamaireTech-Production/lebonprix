rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isManager() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'manager';
    }
    
    // Helper function to check if user belongs to a company
    function isMemberOfCompany(companyId) {
      return isAuthenticated() && (
        // Legacy: check if companyId matches userId (for grandfathered companies)
        companyId == request.auth.uid ||
        // Check if user is owner of the company (new architecture)
        get(/databases/$(database)/documents/companies/$(companyId)).data.userId == request.auth.uid ||
        // Check if employee exists in the employeeRefs subcollection (new architecture)
        // If document exists and is not deleted, user is a member
        (exists(/databases/$(database)/documents/companies/$(companyId)/employeeRefs/$(request.auth.uid)) && 
         get(/databases/$(database)/documents/companies/$(companyId)/employeeRefs/$(request.auth.uid)).data.deleted != true)
      );
    }
    
    // Helper function to check if user owns a company
    function isOwnerOfCompany(companyId) {
      return isAuthenticated() && (
        // Legacy: check if companyId is userId (grandfathered companies)
        companyId == request.auth.uid ||
        // New: check userId field in company
        get(/databases/$(database)/documents/companies/$(companyId)).data.userId == request.auth.uid
      );
    }
    
    function isUserInSameCompany(userId) {
      let user = get(/databases/$(database)/documents/users/$(userId)).data;
      let currentUser = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
      
      // Simplified check - if both users exist, they might share a company
      return user != null && currentUser != null;
    }
    
    // Helper function to check companyId access for documents
    function hasCompanyAccess(companyId) {
      return isMemberOfCompany(companyId);
    }
    
    // User profiles - Nouveau système unifié
    match /users/{userId} {
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || 
        isUserInSameCompany(userId)
      );
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false; // Pas de suppression complète
    }
    
    // Products - Company-scoped access
    match /products/{productId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      
      // Validate product data
      function isValidProduct() {
        let data = request.resource.data;
        return data.name is string && data.name.size() > 0 &&
               data.costPrice is number && data.costPrice >= 0 &&
               data.sellingPrice is number && data.sellingPrice >= data.costPrice &&
               data.stock is number && data.stock >= 0 &&
               (!('category' in data) || data.category is string) &&
               data.companyId is string &&
               (!('imageUrl' in data) || data.imageUrl is string) &&
               data.isAvailable is bool;
      }
      
      allow create: if isValidProduct() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isValidProduct() && hasCompanyAccess(request.resource.data.companyId);
    }
    
    // Sales - Company-scoped access
    match /sales/{saleId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      
      // Validate sale data - Only required fields
      // Default values (status, paymentStatus, customerInfo, etc.) are handled by the code
      function isValidSale() {
        let data = request.resource.data;
        return data.products is list && data.products.size() > 0 &&
               data.totalAmount is number && data.totalAmount >= 0 &&
               data.companyId is string &&
               data.userId is string &&
               data.createdAt is timestamp;
      }
      
      allow create: if isValidSale() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isValidSale() && hasCompanyAccess(request.resource.data.companyId);
    }
    
    // Expenses - Company-scoped access
    match /expenses/{expenseId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      
      // Validate expense data
      function isValidExpense() {
        let data = request.resource.data;
        return data.description is string && data.description.size() > 0 &&
               data.amount is number && data.amount > 0 &&
               data.companyId is string &&
               // Vérifier date OU createdAt (rétrocompatibilité)
               ((data.date is timestamp) || (data.createdAt is timestamp)) &&
               (!('attachments' in data) || (data.attachments is list && data.attachments.size() <= 5));
      }
      
      // Empêcher la modification de createdAt lors d'un update
      function createdAtNotModified() {
        return !('createdAt' in request.resource.data) || 
               request.resource.data.createdAt == resource.data.createdAt;
      }
      
      allow create: if isValidExpense() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isValidExpense() && hasCompanyAccess(request.resource.data.companyId) && createdAtNotModified();
    }
    
    // Dashboard stats - Company-scoped access
    match /dashboardStats/{statsId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow write: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
    }
    
    // Finances - Company-scoped access
    match /finances/{financeId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if false; // Only soft deletion allowed
    }

    // Finance Entry Types - Company-scoped for user-specific, public for default
    match /financeEntryTypes/{typeId} {
      // Default types (isDefault == true) are readable by all, not writable
      allow read: if true;
      allow create: if isAuthenticated() && 
        (!('isDefault' in request.resource.data) || request.resource.data.isDefault == false) && 
        hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && 
        (!('isDefault' in resource.data) || resource.data.isDefault == false) &&
        hasCompanyAccess(resource.data.companyId);
      allow delete: if false; // No hard delete
    }
    
    // Expense Types - Company-scoped for user-specific, public for default
    match /expenseTypes/{typeId} {
      allow read: if true; // Public read (default types available to all)
      allow create: if isAuthenticated() && 
        (!('isDefault' in request.resource.data) || request.resource.data.isDefault == false) &&
        hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && 
        (!('isDefault' in resource.data) || resource.data.isDefault == false) &&
        hasCompanyAccess(resource.data.companyId);
      allow delete: if false;
    }
    
    // Companies - Architecture simplifiée
    match /companies/{companyId} {
      allow read: if true; // Public read for landing pages
      allow create: if isAuthenticated(); // N'importe quel utilisateur connecté peut créer
      allow update: if isAuthenticated() && isOwnerOfCompany(companyId);
      allow delete: if isAuthenticated() && isOwnerOfCompany(companyId);
      
      // Employee subcollection
      match /employees/{employeeId} {
        allow read: if isAuthenticated() && isMemberOfCompany(companyId);
        allow create: if isAuthenticated() && isOwnerOfCompany(companyId);
        allow update: if isAuthenticated() && isOwnerOfCompany(companyId);
        allow delete: if isAuthenticated() && isOwnerOfCompany(companyId);
        
        // Validate employee data
        function isValidEmployee() {
          let data = request.resource.data;
          return data.id is string && data.id.size() > 0 &&
                 data.firstname is string && data.firstname.size() > 0 &&
                 data.lastname is string && data.lastname.size() > 0 &&
                 data.email is string && data.email.matches('.*@.*\\..*') &&
                 data.role in ['admin', 'manager', 'staff'] &&
                 data.createdAt is timestamp &&
                 data.updatedAt is timestamp &&
                 (!('phone' in data) || data.phone is string) &&
                 (!('birthday' in data) || data.birthday is string) &&
                 (!('loginLink' in data) || data.loginLink is string) &&
                 (!('firebaseUid' in data) || data.firebaseUid is string);
        }
        
        allow create: if isValidEmployee();
        allow update: if isValidEmployee();
      }
      
      // Profit Period Preference subcollection
      match /profitPeriodPreference/{prefId} {
        allow read: if isAuthenticated() && isMemberOfCompany(companyId);
        allow write: if isAuthenticated() && 
          isMemberOfCompany(companyId) &&
          request.resource.data.companyId == companyId &&
          request.resource.data.updatedBy == request.auth.uid;
      }
    }

    // Audit Logs
    match /auditLogs/{logId} {
      allow read: if isAuthenticated() && resource.data.performedBy == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.performedBy == request.auth.uid;
      allow update: if false; // Audit logs should not be updated
      allow delete: if false; // Audit logs should not be deleted
    }
    
    // Categories - Company-scoped access
    match /categories/{categoryId} {
      allow read: if true; // Public read for landing pages
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
    }
    
    // Suppliers - Company-scoped access
    match /suppliers/{supplierId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
    }
    
    // Objectives - Company-scoped access
    match /objectives/{objectiveId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
    }
    
    // Stock Batches - Company-scoped access
    match /stockBatches/{batchId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if false; // Stock batches should not be deleted directly
    }
    
    // Stock Changes - Company-scoped access
    match /stockChanges/{changeId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if false; // Stock changes are immutable
      allow delete: if false; // Stock changes should not be deleted
    }
    
    // Customers - Company-scoped access
    match /customers/{customerId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if false; // Soft delete only
    }
    
    // Orders - Company-scoped access
    match /orders/{orderId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if false; // Only soft deletion allowed
      
      // Validate order data
      function isValidOrder() {
        let data = request.resource.data;
        return data.orderId is string && data.orderId.size() > 0 &&
               data.orderNumber is string && data.orderNumber.size() > 0 &&
               data.companyId is string &&
               data.customerInfo.name is string && data.customerInfo.name.size() > 0 &&
               data.customerInfo.phone is string && data.customerInfo.phone.size() > 0 &&
               data.customerInfo.location is string && data.customerInfo.location.size() > 0 &&
               data.items is list && data.items.size() > 0 &&
               data.pricing.subtotal is number && data.pricing.subtotal >= 0 &&
               data.pricing.deliveryFee is number && data.pricing.deliveryFee >= 0 &&
               data.pricing.total is number && data.pricing.total >= 0 &&
               data.orderType in ['whatsapp', 'online'] &&
               data.status in ['pending', 'confirmed', 'preparing', 'ready', 'delivered', 'cancelled'] &&
               data.paymentStatus in ['pending', 'paid', 'failed', 'awaiting_payment', 'cancelled'] &&
               data.paymentMethod in ['onsite', 'online', 'whatsapp'] &&
               data.deliveryInfo.method in ['pickup', 'delivery'] &&
               data.timeline is list &&
               data.metadata.source in ['catalogue', 'admin', 'checkout', 'checkout_modal'];
      }
      
      allow create: if isValidOrder() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isValidOrder() && hasCompanyAccess(request.resource.data.companyId);
    }
    
    // Order Events - Subcollection for order timeline
    match /orders/{orderId}/events/{eventId} {
      allow read: if isAuthenticated() && 
        hasCompanyAccess(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow create: if isAuthenticated() && 
        hasCompanyAccess(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow update: if false; // Events should not be updated
      allow delete: if false; // Events should not be deleted
    }
    
    // Order Payments - Subcollection for payment history
    match /orders/{orderId}/payments/{paymentId} {
      allow read: if isAuthenticated() && 
        hasCompanyAccess(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow create: if isAuthenticated() && 
        hasCompanyAccess(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow update: if isAuthenticated() && 
        hasCompanyAccess(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow delete: if false; // Payments should not be deleted
    }
    
    // Order Notes - Subcollection for order notes
    match /orders/{orderId}/notes/{noteId} {
      allow read: if isAuthenticated() && 
        hasCompanyAccess(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow create: if isAuthenticated() && 
        hasCompanyAccess(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow update: if isAuthenticated() && 
        hasCompanyAccess(get(/databases/$(database)/documents/orders/$(orderId)).data.companyId);
      allow delete: if false; // Notes should not be deleted
    }
    
    // CinetPay Configurations - Company-scoped access
    match /cinetpay_configs/{configId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if false; // Configurations should not be deleted
      
      // Validate CinetPay configuration data
      function isValidCinetPayConfig() {
        let data = request.resource.data;
        return data.companyId is string &&
               data.siteId is string &&
               data.apiKey is string &&
               data.isActive is bool &&
               data.testMode is bool &&
               data.enabledChannels.mobileMoney is bool &&
               data.enabledChannels.creditCard is bool &&
               data.enabledChannels.wallet is bool &&
               data.currency == 'XAF';
      }
      
      allow create: if isValidCinetPayConfig() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isValidCinetPayConfig() && hasCompanyAccess(request.resource.data.companyId);
    }
    
    // CinetPay Transactions - Company-scoped access
    match /cinetpay_transactions/{transactionId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow delete: if false; // Transactions should not be deleted
    }
    
    // Production Flow Steps - Company-scoped access
    match /productionFlowSteps/{stepId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
    }
    
    // Production Flows - Company-scoped access
    match /productionFlows/{flowId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
    }
    
    // Production Categories - Company-scoped access
    match /productionCategories/{categoryId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
    }
    
    // Productions - Company-scoped access
    match /productions/{productionId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
    }
    
    // Production Charges - Company-scoped access
    match /productionCharges/{chargeId} {
      allow read: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
      allow create: if isAuthenticated() && hasCompanyAccess(request.resource.data.companyId);
      allow update: if isAuthenticated() && hasCompanyAccess(resource.data.companyId) && hasCompanyAccess(request.resource.data.companyId);
      allow delete: if isAuthenticated() && hasCompanyAccess(resource.data.companyId);
    }
  }
}
