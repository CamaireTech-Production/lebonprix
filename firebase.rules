rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // User profiles
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isAuthenticated() && request.auth.uid == userId;
      allow delete: if false;
    }
    
    // Products - Public read for catalogue (Option A: allow all, client-side filtering)
    // The application already filters by isVisible, isAvailable, isDeleted client-side
    match /products/{productId} {
      // Public read: Allow reading all products (filtering happens client-side)
      // This works for queries since we can't validate individual document fields in query rules
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Sales - SIMPLIFIED: Authenticated users can read/write
    match /sales/{saleId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Expenses - SIMPLIFIED: Authenticated users can read/write
    match /expenses/{expenseId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Dashboard stats - SIMPLIFIED: Authenticated users can read/write
    match /dashboardStats/{statsId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Finances - SIMPLIFIED: Authenticated users can read/write
    match /finances/{financeId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // Finance Entry Types - SIMPLIFIED: Authenticated users can read/write
    match /financeEntryTypes/{typeId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Expense Types - SIMPLIFIED: Authenticated users can read/write
    match /expenseTypes/{typeId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Companies - SIMPLIFIED: Authenticated users can read/write
    match /companies/{companyId} {
      allow read: if true;
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
      
      // Employee subcollection - SIMPLIFIED
      match /employees/{employeeId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Profit Period Preference subcollection - SIMPLIFIED
      match /profitPeriodPreference/{prefId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Employee Refs subcollection - SIMPLIFIED
      match /employeeRefs/{employeeRefId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // Permission Templates subcollection - SIMPLIFIED
      match /permissionTemplates/{templateId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }

    // Audit Logs - SIMPLIFIED: Authenticated users can read/write
    match /auditLogs/{logId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // Categories - SIMPLIFIED: Authenticated users can read/write
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }
    
    // Suppliers - SIMPLIFIED: Authenticated users can read/write
    match /suppliers/{supplierId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Objectives - SIMPLIFIED: Authenticated users can read/write
    match /objectives/{objectiveId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Stock Batches - SIMPLIFIED: Authenticated users can read/write
    match /stockBatches/{batchId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Stock Changes - SIMPLIFIED: Authenticated users can read/write
    match /stockChanges/{changeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // Customers - SIMPLIFIED: Authenticated users can read/write
    match /customers/{customerId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Customer Sources - SIMPLIFIED: Authenticated users can read/write
    match /customerSources/{sourceId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Orders - SIMPLIFIED: Authenticated users can read/write
    match /orders/{orderId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Order Events - SIMPLIFIED: Authenticated users can read/write
    match /orders/{orderId}/events/{eventId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false;
      allow delete: if false;
    }
    
    // Order Payments - SIMPLIFIED: Authenticated users can read/write
    match /orders/{orderId}/payments/{paymentId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Order Notes - SIMPLIFIED: Authenticated users can read/write
    match /orders/{orderId}/notes/{noteId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // CinetPay Configurations - Public read for catalogue checkout, authenticated write
    match /cinetpay_configs/{configId} {
      allow read: if true; // Public read for guest checkout
      allow write: if isAuthenticated(); // Only authenticated users can write
    }
    
    // CinetPay Transactions - SIMPLIFIED: Authenticated users can read/write
    match /cinetpay_transactions/{transactionId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Campay Configurations - Public read for catalogue checkout, authenticated write
    match /campay_configs/{configId} {
      allow read: if true; // Public read for guest checkout
      allow write: if isAuthenticated(); // Only authenticated users can write
    }
    
    // Checkout Settings - Public read for catalogue checkout, authenticated write
    match /checkout_settings/{userId} {
      allow read: if true; // Public read for guest checkout
      allow write: if isAuthenticated(); // Only authenticated users can write
    }
    
    // Seller Settings - Public read for catalogue checkout, authenticated write
    match /sellerSettings/{userId} {
      allow read: if true; // Public read for guest checkout
      allow write: if isAuthenticated(); // Only authenticated users can write
    }
    
    // Production Flow Steps - SIMPLIFIED: Authenticated users can read/write
    match /productionFlowSteps/{stepId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Production Flows - SIMPLIFIED: Authenticated users can read/write
    match /productionFlows/{flowId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Production Categories - SIMPLIFIED: Authenticated users can read/write
    match /productionCategories/{categoryId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Productions - SIMPLIFIED: Authenticated users can read/write
    match /productions/{productionId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Charges - SIMPLIFIED: Authenticated users can read/write
    match /charges/{chargeId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Production Charges - SIMPLIFIED: Authenticated users can read/write
    match /productionCharges/{chargeId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Matieres - SIMPLIFIED: Authenticated users can read/write
    match /matieres/{matiereId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Site Analytics - Public read/write for tracking catalogue views
    match /siteAnalytics/{analyticsId} {
      allow read: if true; // Allow public read to check if document exists
      allow create: if true; // Allow public writes for tracking
      allow update: if true; // Allow public updates for tracking (increment views)
      allow delete: if false;
    }
  }
}
